<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greig Boomwhacker Assignment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 100%;
            height: calc(100vh - 40px);
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 32px;
            color: #2c3e50;
            margin: 0;
            flex: 1;
            min-width: 300px;
        }

        .inventory-display {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .inventory-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .inventory-count {
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .assign-btn {
            font-size: 18px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
        }

        @keyframes flyToStudent {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }

            50% {
                transform: translate(var(--fly-x), var(--fly-y)) scale(1.5);
                opacity: 0.7;
            }

            100% {
                transform: translate(var(--fly-x), var(--fly-y)) scale(1);
                opacity: 0;
            }
        }

        .flying-chip {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            animation: flyToStudent 0.8s ease-in-out forwards;
        }

        .assign-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .assign-btn:active {
            transform: translateY(0);
        }

        .student-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
        }

        .student-card {
            background: white;
            border-radius: 12px;
            padding: 12px 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-card.absent {
            opacity: 0.4;
            background: #ecf0f1;
        }

        .student-card:not(.absent):hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .student-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            min-width: 100px;
            flex-shrink: 0;
        }

        .boomwhacker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #bdc3c7;
            min-height: 40px;
        }

        .boomwhacker-list.drag-over {
            border-color: #3498db;
            background: #ebf5fb;
        }

        .boomwhacker-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 28px;
            /* Increased by 75% from 16px */
            font-weight: bold;
            color: white;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            user-select: none;
        }

        .boomwhacker-chip:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .boomwhacker-chip.dragging {
            opacity: 0.5;
        }

        /* Note colors based on solfege system */
        .note-C {
            background-color: #e74c3c;
        }

        /* Do - Red */
        .note-D {
            background-color: #e67e22;
        }

        /* Re - Orange */
        .note-E {
            background-color: #f1c40f;
        }

        /* Mi - Yellow */
        .note-F {
            background-color: #3498db;
        }

        /* Blue */
        .note-G {
            background-color: #27ae60;
        }

        /* So - Green */
        .note-A {
            background-color: #9b59b6;
        }

        /* La - Purple */
        .note-B {
            background-color: #e91e63;
        }

        /* Pink */

        /* Accidentals */
        .note-Cs,
        .note-Db {
            background-color: #c0392b;
        }

        .note-Ds,
        .note-Eb {
            background-color: #d4a017;
            /* Mustard */
        }

        .note-Fs,
        .note-Gb {
            background-color: #1f618d;
        }

        .note-Gs,
        .note-Ab {
            background-color: #3498db;
            /* Blue */
        }

        .note-As,
        .note-Bb {
            background-color: #ad1457;
        }

        .melody-label {
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #2c3e50;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .student-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .assign-btn {
                font-size: 18px;
                padding: 12px 30px;
            }
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽµ Boomwhacker Assignment ðŸŽµ</h1>
            <div class="inventory-display" id="inventoryDisplay">
                <!-- Inventory will be dynamically generated here -->
            </div>
            <div class="button-group">
                <button class="assign-btn" onclick="assignBoomwhackers(1)">Assign 1 Boomwhacker</button>
                <button class="assign-btn" onclick="assignBoomwhackers(2)">Assign 2 Boomwhackers</button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>Melody 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e91e63;"></div>
                <span>Melody 2</span>
            </div>
        </div>

        <div class="student-grid" id="studentGrid">
            <!-- Student cards will be dynamically generated here -->
        </div>
    </div>

    <script>
        // Listen for init message from parent
        window.addEventListener('message', (event) => {
            if (event.data.type === 'taskmodule:init') {
                console.log('Received init message:', event.data);
                if (window.TaskModule && window.TaskModule.init) {
                    window.TaskModule.init(event.data.context, event.data.savedSettings);
                }
            }
        });

        // TaskModule interface for integration
        window.TaskModule = {
            context: null,

            init(context) {
                this.context = context;
                console.log('Boomwhacker Assignment initialized with context:', context);

                // Load students and attendance data
                initModule(context);
            },

            getResponse() {
                return getCurrentAssignments();
            },

            isComplete() {
                // Always considered complete (manual assignment task)
                return true;
            },

            reset() {
                resetAssignments();
            }
        };

        // Song configuration  - note names with octave specifiers
        const melody1Notes = [
            { note: 'A', octave: 'low' },
            { note: 'C', octave: 'low' },
            { note: 'E', octave: 'regular' },
            { note: 'D#', octave: 'regular' },
            { note: 'D', octave: 'regular' },
            { note: 'G', octave: 'regular' }
        ];

        const melody2Notes = [
            { note: 'E', octave: 'regular' },
            { note: 'G', octave: 'regular' },
            { note: 'G#', octave: 'regular' },
            { note: 'B', octave: 'regular' },
            { note: 'C', octave: 'high' }
        ];

        // Boomwhacker inventory - will be loaded from CSV
        let inventory = {};
        let inventoryLoaded = false;

        let students = [];
        let assignments = {}; // studentId -> array of {note, octave, melody}
        let draggedChip = null;
        let sourceStudent = null;

        // Load inventory from CSV
        async function loadInventory() {
            try {
                const response = await fetch('../boomwhacker_inventory.csv');
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');

                // Skip header row
                for (let i = 1; i < lines.length; i++) {
                    const [note, octave, quantity] = lines[i].split(',');
                    if (note && octave && quantity) {
                        const key = `${note}_${octave}`;
                        inventory[key] = parseInt(quantity);
                    }
                }

                inventoryLoaded = true;
                console.log('Loaded inventory:', inventory);
                renderInventory();
            } catch (error) {
                console.error('Error loading inventory:', error);
                // Fallback to hardcoded values if CSV fails
                inventory = {
                    'A_low': 2, 'A_regular': 6, 'A_high': 1,
                    'C_low': 2, 'C_regular': 6, 'C_high': 6,
                    'D_low': 2, 'D_regular': 6, 'D_high': 2,
                    'D#_regular': 3,
                    'E_low': 2, 'E_regular': 6, 'E_high': 1,
                    'G_low': 1, 'G_regular': 6, 'G_high': 1,
                    'G#_regular': 3,
                    'B_low': 2, 'B_regular': 3, 'B_high': 1
                };
                inventoryLoaded = true;
                renderInventory();
            }
        }

        // Helper function to get inventory key
        function getInventoryKey(noteObj) {
            return `${noteObj.note}_${noteObj.octave}`;
        }

        function initModule(context) {
            // Load inventory from CSV
            loadInventory();

            // Show loading state
            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '<div class="empty-state">Loading students...</div>';

            // Listen for student data BEFORE requesting it
            window.addEventListener('message', (event) => {
                if (event.data.type === 'taskmodule:students-data') {
                    console.log('Received student data:', event.data.students);
                    students = event.data.students || [];
                    renderStudentGrid();
                }
            });

            // Request student list from parent
            console.log('Requesting student list from parent...');
            window.parent.postMessage({
                type: 'taskmodule:request-students'
            }, '*');

            // Request existing response to restore previous assignments
            if (context && context.existingResponse) {
                try {
                    assignments = JSON.parse(context.existingResponse);
                    console.log('Restored assignments:', assignments);
                } catch (e) {
                    console.log('No valid existing assignments');
                    assignments = {};
                }
            }
        }

        function renderInventory() {
            const inventoryContainer = document.getElementById('inventoryDisplay');
            inventoryContainer.innerHTML = '';

            if (!inventoryLoaded) {
                inventoryContainer.innerHTML = '<div class="empty-state" style="font-size: 12px;">Loading inventory...</div>';
                return;
            }

            // Get all unique note/octave combinations used in both melodies
            const allNoteObjs = [...melody1Notes, ...melody2Notes];
            const uniqueNotes = [];
            const seen = new Set();

            allNoteObjs.forEach(noteObj => {
                const key = getInventoryKey(noteObj);
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueNotes.push(noteObj);
                }
            });

            uniqueNotes.forEach(noteObj => {
                const key = getInventoryKey(noteObj);
                const count = inventory[key] || 0;
                const item = document.createElement('div');

                // Use just the base note for color class (C, D, E, etc)
                const baseNote = noteObj.note.replace('#', 's').replace('â™­', 'b');
                item.className = `inventory-item note-${baseNote}`;

                const noteName = document.createElement('span');
                noteName.textContent = formatNoteName(noteObj);

                const countBadge = document.createElement('span');
                countBadge.className = 'inventory-count';
                countBadge.textContent = `Ã—${count}`;

                item.appendChild(noteName);
                item.appendChild(countBadge);
                item.dataset.note = noteObj.note;
                item.dataset.octave = noteObj.octave;
                inventoryContainer.appendChild(item);
            });
        }

        function renderStudentGrid() {
            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '';

            // Render inventory on first call
            renderInventory();

            if (students.length === 0) {
                grid.innerHTML = '<div class="empty-state">No students loaded. Please load students in the main app.</div>';
                return;
            }

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.dataset.studentId = student.student_id;

                // Check if student is marked absent
                if (student.isAbsent) {
                    card.classList.add('absent');
                }

                const name = document.createElement('div');
                name.className = 'student-name';
                name.textContent = student.name;

                const boomwhackerList = document.createElement('div');
                boomwhackerList.className = 'boomwhacker-list';
                boomwhackerList.dataset.studentId = student.student_id;

                // Add drag and drop listeners
                boomwhackerList.addEventListener('dragover', handleDragOver);
                boomwhackerList.addEventListener('drop', handleDrop);
                boomwhackerList.addEventListener('dragleave', handleDragLeave);

                // Display assigned boomwhackers
                const studentAssignment = assignments[student.student_id];
                const studentNotes = studentAssignment?.notes || studentAssignment || [];

                if (Array.isArray(studentNotes) && studentNotes.length > 0) {
                    studentNotes.forEach(noteObj => {
                        boomwhackerList.appendChild(createBoomwhackerChip(noteObj, student.student_id));
                    });
                } else {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'empty-state';
                    placeholder.textContent = 'No assignment';
                    placeholder.style.fontSize = '14px';
                    placeholder.style.padding = '5px';
                    boomwhackerList.appendChild(placeholder);
                }

                card.appendChild(name);
                card.appendChild(boomwhackerList);
                grid.appendChild(card);
            });
        }

        function createBoomwhackerChip(noteObj, studentId) {
            const chip = document.createElement('div');

            // Use base note for color class
            const baseNote = noteObj.note.replace('#', 's').replace('â™­', 'b');
            chip.className = `boomwhacker-chip note-${baseNote}`;
            chip.draggable = true;
            chip.dataset.noteObj = JSON.stringify(noteObj);
            chip.dataset.studentId = studentId;

            const noteText = document.createElement('span');
            noteText.textContent = formatNoteName(noteObj);

            chip.appendChild(noteText);

            chip.addEventListener('dragstart', handleDragStart);
            chip.addEventListener('dragend', handleDragEnd);

            return chip;
        }

        function formatNoteName(noteObj) {
            // Handle both string (old format) and object (new format)
            let noteName, octave;

            if (typeof noteObj === 'object' && noteObj.note) {
                noteName = noteObj.note;
                octave = noteObj.octave;
            } else {
                // Old string format - just return as is
                return String(noteObj).replace('s', '#').replace('b', 'â™­');
            }

            // Format the note name
            const formatted = noteName.replace('#', 'â™¯').replace('b', 'â™­');

            // Add octave indicator using proper musical notation
            if (octave === 'low') {
                return `${formatted},`;  // Low octave uses comma
            } else if (octave === 'high') {
                return `${formatted}'`;  // High octave uses apostrophe
            } else {
                return formatted;  // Regular octave, no marker
            }
        }

        function handleDragStart(e) {
            draggedChip = e.target;
            sourceStudent = e.target.dataset.studentId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedChip = null;
            sourceStudent = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedChip) return;

            const targetStudentId = e.currentTarget.dataset.studentId;
            const note = JSON.parse(draggedChip.dataset.noteObj);

            // Remove from source student
            if (sourceStudent && assignments[sourceStudent]) {
                const sourceNotes = assignments[sourceStudent].notes || assignments[sourceStudent];
                if (Array.isArray(sourceNotes)) {
                    const filteredNotes = sourceNotes.filter(n =>
                        !(n.note === note.note && n.octave === note.octave)
                    );

                    if (filteredNotes.length > 0) {
                        assignments[sourceStudent] = { notes: filteredNotes };
                    } else {
                        delete assignments[sourceStudent];
                    }
                }
            }

            // Add to target student
            if (!assignments[targetStudentId]) {
                assignments[targetStudentId] = { notes: [] };
            }

            // Ensure notes array exists
            if (!assignments[targetStudentId].notes) {
                assignments[targetStudentId] = { notes: [] };
            }

            // Check if the target student already has this specific note
            const targetNotes = assignments[targetStudentId].notes;
            const alreadyHas = targetNotes.some(n => n.note === note.note && n.octave === note.octave);

            if (!alreadyHas) {
                targetNotes.push(note);
            }

            // Re-render and save
            renderStudentGrid();
            notifyParent();
        }

        function assignBoomwhackers(count) {
            // Clear existing assignments
            assignments = {};

            // Get present students only
            const presentStudents = students.filter(s => !s.isAbsent);

            if (presentStudents.length === 0) {
                alert('No students present to assign boomwhackers!');
                return;
            }

            if (count === 1) {
                assignOneBoomwhacker(presentStudents);
            } else if (count === 2) {
                assignTwoBoomwhackers(presentStudents);
            }

            renderStudentGrid();
            notifyParent();
        }

        function assignOneBoomwhacker(presentStudents) {
            // Combine both melodies
            const allNotes = [...melody1Notes, ...melody2Notes];

            // Ensure each unique note is covered at least once
            const uniqueNotes = [];
            const seen = new Set();
            allNotes.forEach(noteObj => {
                const key = getInventoryKey(noteObj);
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueNotes.push(noteObj);
                }
            });

            // Track available inventory
            const availableInventory = { ...inventory };

            // Shuffle students
            const shuffledStudents = [...presentStudents].sort(() => Math.random() - 0.5);

            // First pass: ensure every note is covered at least once
            const coveredNotes = new Set();
            const studentAssignments = new Map();

            shuffledStudents.forEach(student => {
                // Find notes not yet covered that are still available
                const uncovered = uniqueNotes.filter(note => {
                    const key = getInventoryKey(note);
                    return !coveredNotes.has(key) && availableInventory[key] > 0;
                });

                if (uncovered.length > 0) {
                    // Assign an uncovered note
                    const note = uncovered[Math.floor(Math.random() * uncovered.length)];
                    const key = getInventoryKey(note);
                    coveredNotes.add(key);
                    availableInventory[key]--;

                    if (!studentAssignments.has(student.student_id)) {
                        studentAssignments.set(student.student_id, []);
                    }
                    studentAssignments.get(student.student_id).push(note);
                }
            });

            // Second pass: assign remaining students any available note
            shuffledStudents.forEach(student => {
                if (!studentAssignments.has(student.student_id)) {
                    const availableNotes = uniqueNotes.filter(note => {
                        const key = getInventoryKey(note);
                        return availableInventory[key] > 0;
                    });

                    if (availableNotes.length > 0) {
                        const note = availableNotes[Math.floor(Math.random() * availableNotes.length)];
                        const key = getInventoryKey(note);
                        availableInventory[key]--;

                        studentAssignments.set(student.student_id, [note]);
                    }
                }
            });

            // Convert to assignments object
            studentAssignments.forEach((notes, studentId) => {
                assignments[studentId] = { notes: notes };
            });
        }

        function assignTwoBoomwhackers(presentStudents) {
            // Combine both melodies
            const allNotes = [...melody1Notes, ...melody2Notes];

            // Get unique notes
            const uniqueNotes = [];
            const seen = new Set();
            allNotes.forEach(noteObj => {
                const key = getInventoryKey(noteObj);
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueNotes.push(noteObj);
                }
            });

            // Track available inventory
            const availableInventory = { ...inventory };

            // Shuffle students
            const shuffledStudents = [...presentStudents].sort(() => Math.random() - 0.5);

            // Assign 2 different boomwhackers to each student when possible
            const coveredNotes = new Set();
            const studentAssignments = new Map();

            // First pass: ensure coverage
            shuffledStudents.forEach(student => {
                const uncovered = uniqueNotes.filter(note => {
                    const key = getInventoryKey(note);
                    return !coveredNotes.has(key) && availableInventory[key] > 0;
                });

                if (uncovered.length > 0 && !studentAssignments.has(student.student_id)) {
                    const note = uncovered[Math.floor(Math.random() * uncovered.length)];
                    const key = getInventoryKey(note);
                    coveredNotes.add(key);
                    availableInventory[key]--;

                    studentAssignments.set(student.student_id, [note]);
                }
            });

            // Second pass: try to give everyone a second boomwhacker (different from first)
            shuffledStudents.forEach(student => {
                const current = studentAssignments.get(student.student_id) || [];

                if (current.length < 2) {
                    // Find available notes different from what they already have
                    const availableNotes = uniqueNotes.filter(note => {
                        const key = getInventoryKey(note);
                        const alreadyHas = current.some(n => getInventoryKey(n) === key);
                        return !alreadyHas && availableInventory[key] > 0;
                    });

                    if (availableNotes.length > 0) {
                        const note = availableNotes[Math.floor(Math.random() * availableNotes.length)];
                        const key = getInventoryKey(note);
                        availableInventory[key]--;

                        current.push(note);
                        studentAssignments.set(student.student_id, current);
                    }
                }
            });

            // Convert to assignments object
            studentAssignments.forEach((notes, studentId) => {
                assignments[studentId] = { notes: notes };
            });
        }

        function getCurrentAssignments() {
            return JSON.stringify(assignments);
        }

        function notifyParent() {
            window.parent.postMessage({
                type: 'taskmodule:response',
                value: getCurrentAssignments(),
                isComplete: true
            }, '*');
        }

        function resetAssignments() {
            assignments = {};
            renderStudentGrid();
        }
    </script>
</body>

</html>