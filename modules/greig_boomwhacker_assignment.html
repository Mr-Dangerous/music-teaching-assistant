<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greig Boomwhacker Assignment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 100%;
            height: calc(100vh - 40px);
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 32px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .assign-btn {
            font-size: 24px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
            transition: all 0.3s ease;
        }

        .assign-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);
        }

        .assign-btn:active {
            transform: translateY(0);
        }

        .student-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
        }

        .student-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .student-card.absent {
            opacity: 0.4;
            background: #ecf0f1;
        }

        .student-card:not(.absent):hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        .student-name {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .boomwhacker-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #bdc3c7;
        }

        .boomwhacker-list.drag-over {
            border-color: #3498db;
            background: #ebf5fb;
        }

        .boomwhacker-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: grab;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            user-select: none;
        }

        .boomwhacker-chip:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .boomwhacker-chip.dragging {
            opacity: 0.5;
        }

        /* Note colors based on solfege system */
        .note-C {
            background-color: #e74c3c;
        }

        /* Do - Red */
        .note-D {
            background-color: #e67e22;
        }

        /* Re - Orange */
        .note-E {
            background-color: #f1c40f;
        }

        /* Mi - Yellow */
        .note-F {
            background-color: #3498db;
        }

        /* Blue */
        .note-G {
            background-color: #27ae60;
        }

        /* So - Green */
        .note-A {
            background-color: #9b59b6;
        }

        /* La - Purple */
        .note-B {
            background-color: #e91e63;
        }

        /* Pink */

        /* Accidentals */
        .note-Cs,
        .note-Db {
            background-color: #c0392b;
        }

        .note-Ds,
        .note-Eb {
            background-color: #d68910;
        }

        .note-Fs,
        .note-Gb {
            background-color: #1f618d;
        }

        .note-Gs,
        .note-Ab {
            background-color: #196f3d;
        }

        .note-As,
        .note-Bb {
            background-color: #ad1457;
        }

        .melody-label {
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #2c3e50;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .student-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .assign-btn {
                font-size: 18px;
                padding: 12px 30px;
            }
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 15px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽµ Boomwhacker Assignment ðŸŽµ</h1>
            <button class="assign-btn" onclick="assignBoomwhackers()">Ready to Assign!</button>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3498db;"></div>
                <span>Melody 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #e91e63;"></div>
                <span>Melody 2</span>
            </div>
        </div>

        <div class="student-grid" id="studentGrid">
            <!-- Student cards will be dynamically generated here -->
        </div>
    </div>

    <script>
        // TaskModule interface for integration
        window.TaskModule = {
            context: null,

            init(context) {
                this.context = context;
                console.log('Boomwhacker Assignment initialized with context:', context);

                // Load students and attendance data
                initModule(context);
            },

            getResponse() {
                return getCurrentAssignments();
            },

            isComplete() {
                // Always considered complete (manual assignment task)
                return true;
            },

            reset() {
                resetAssignments();
            }
        };

        // Song configuration
        const melody1Notes = ['A', 'C', 'E', 'Ds', 'D', 'G']; // Using 'Ds' for D#
        const melody2Notes = ['E', 'G', 'Gs', 'B', 'C']; // Using 'Gs' for G#, high C

        // Boomwhacker inventory (quantities)
        const inventory = {
            'A': 4, 'C': 4, 'D': 4, 'Ds': 2, 'E': 4, 'G': 4, 'Gs': 2, 'B': 4
        };

        let students = [];
        let assignments = {}; // studentId -> {melody1: 'note', melody2: 'note'}
        let draggedChip = null;
        let sourceStudent = null;

        function initModule(context) {
            // Show loading state
            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '<div class="empty-state">Loading students...</div>';

            // Listen for student data BEFORE requesting it
            window.addEventListener('message', (event) => {
                if (event.data.type === 'taskmodule:students-data') {
                    console.log('Received student data:', event.data.students);
                    students = event.data.students || [];
                    renderStudentGrid();
                }
            });

            // Request student list from parent
            console.log('Requesting student list from parent...');
            window.parent.postMessage({
                type: 'taskmodule:request-students'
            }, '*');

            // Request existing response to restore previous assignments
            if (context && context.existingResponse) {
                try {
                    assignments = JSON.parse(context.existingResponse);
                    console.log('Restored assignments:', assignments);
                } catch (e) {
                    console.log('No valid existing assignments');
                    assignments = {};
                }
            }
        }

        function renderStudentGrid() {
            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '';

            if (students.length === 0) {
                grid.innerHTML = '<div class="empty-state">No students loaded. Please load students in the main app.</div>';
                return;
            }

            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.dataset.studentId = student.student_id;

                // Check if student is marked absent
                if (student.isAbsent) {
                    card.classList.add('absent');
                }

                const name = document.createElement('div');
                name.className = 'student-name';
                name.textContent = student.name;

                const boomwhackerList = document.createElement('div');
                boomwhackerList.className = 'boomwhacker-list';
                boomwhackerList.dataset.studentId = student.student_id;

                // Add drag and drop listeners
                boomwhackerList.addEventListener('dragover', handleDragOver);
                boomwhackerList.addEventListener('drop', handleDrop);
                boomwhackerList.addEventListener('dragleave', handleDragLeave);

                // Display assigned boomwhackers
                const studentAssignments = assignments[student.student_id] || {};
                if (studentAssignments.melody1) {
                    boomwhackerList.appendChild(createBoomwhackerChip(studentAssignments.melody1, 1, student.student_id));
                }
                if (studentAssignments.melody2) {
                    boomwhackerList.appendChild(createBoomwhackerChip(studentAssignments.melody2, 2, student.student_id));
                }

                if (!studentAssignments.melody1 && !studentAssignments.melody2) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'empty-state';
                    placeholder.textContent = 'No assignment';
                    placeholder.style.fontSize = '14px';
                    placeholder.style.padding = '5px';
                    boomwhackerList.appendChild(placeholder);
                }

                card.appendChild(name);
                card.appendChild(boomwhackerList);
                grid.appendChild(card);
            });
        }

        function createBoomwhackerChip(note, melodyNum, studentId) {
            const chip = document.createElement('div');
            chip.className = `boomwhacker-chip note-${note}`;
            chip.draggable = true;
            chip.dataset.note = note;
            chip.dataset.melody = melodyNum;
            chip.dataset.studentId = studentId;

            const noteText = document.createElement('span');
            noteText.textContent = formatNoteName(note);

            const label = document.createElement('span');
            label.className = 'melody-label';
            label.textContent = `M${melodyNum}`;

            chip.appendChild(noteText);
            chip.appendChild(label);

            chip.addEventListener('dragstart', handleDragStart);
            chip.addEventListener('dragend', handleDragEnd);

            return chip;
        }

        function formatNoteName(note) {
            return note.replace('s', '#').replace('b', 'â™­');
        }

        function handleDragStart(e) {
            draggedChip = e.target;
            sourceStudent = e.target.dataset.studentId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedChip = null;
            sourceStudent = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedChip) return;

            const targetStudentId = e.currentTarget.dataset.studentId;
            const note = draggedChip.dataset.note;
            const melodyNum = parseInt(draggedChip.dataset.melody);

            // Remove from source student
            if (sourceStudent && assignments[sourceStudent]) {
                if (assignments[sourceStudent].melody1 === note && melodyNum === 1) {
                    delete assignments[sourceStudent].melody1;
                }
                if (assignments[sourceStudent].melody2 === note && melodyNum === 2) {
                    delete assignments[sourceStudent].melody2;
                }
                // Clean up empty assignment objects
                if (!assignments[sourceStudent].melody1 && !assignments[sourceStudent].melody2) {
                    delete assignments[sourceStudent];
                }
            }

            // Add to target student
            if (!assignments[targetStudentId]) {
                assignments[targetStudentId] = {};
            }

            if (melodyNum === 1) {
                assignments[targetStudentId].melody1 = note;
            } else {
                assignments[targetStudentId].melody2 = note;
            }

            // Re-render and save
            renderStudentGrid();
            notifyParent();
        }

        function assignBoomwhackers() {
            // Clear existing assignments
            assignments = {};

            // Get present students only
            const presentStudents = students.filter(s => !s.isAbsent);

            if (presentStudents.length === 0) {
                alert('No students present to assign boomwhackers!');
                return;
            }

            // Distribute melody 1 notes
            const melody1Distribution = distributeMelody(presentStudents, melody1Notes, 1);

            // Distribute melody 2 notes
            const melody2Distribution = distributeMelody(presentStudents, melody2Notes, 2);

            // Merge distributions
            presentStudents.forEach(student => {
                const studentId = student.student_id;

                if (!assignments[studentId]) {
                    assignments[studentId] = {};
                }

                if (melody1Distribution[studentId]) {
                    assignments[studentId].melody1 = melody1Distribution[studentId];
                }

                if (melody2Distribution[studentId]) {
                    assignments[studentId].melody2 = melody2Distribution[studentId];
                }
            });

            renderStudentGrid();
            notifyParent();
        }

        function distributeMelody(presentStudents, melodyNotes, melodyNum) {
            const distribution = {};
            const availableNotes = {};

            // Initialize available counts
            melodyNotes.forEach(note => {
                availableNotes[note] = inventory[note] || 4;
            });

            // Shuffle students for random distribution
            const shuffledStudents = [...presentStudents].sort(() => Math.random() - 0.5);

            // Try to assign one note per student
            shuffledStudents.forEach(student => {
                // Find notes that still have available boomwhackers
                const availableNotesArray = melodyNotes.filter(note => availableNotes[note] > 0);

                if (availableNotesArray.length > 0) {
                    // Randomly select from available notes
                    const randomNote = availableNotesArray[Math.floor(Math.random() * availableNotesArray.length)];
                    distribution[student.student_id] = randomNote;
                    availableNotes[randomNote]--;
                }
            });

            return distribution;
        }

        function getCurrentAssignments() {
            return JSON.stringify(assignments);
        }

        function notifyParent() {
            window.parent.postMessage({
                type: 'taskmodule:response',
                value: getCurrentAssignments(),
                isComplete: true
            }, '*');
        }

        function resetAssignments() {
            assignments = {};
            renderStudentGrid();
        }
    </script>
</body>

</html>