<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            padding: 20px;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            margin-bottom: 20px;
        }

        .content-header h1 {
            font-size: 32px;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .content-header p {
            font-size: 18px;
            color: #6b7280;
        }

        /* Recordings List */
        .recordings-list {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .recording-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recording-item:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .recording-item.active {
            border-color: #ec4899;
            background: #fdf2f8;
        }

        .recording-name {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .recording-meta {
            font-size: 14px;
            color: #6b7280;
        }

        .no-recordings {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-size: 18px;
        }

        /* Audio Player */
        .player-section {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }

        .player-section h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .current-file {
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        audio {
            width: 100%;
            outline: none;
        }

        audio::-webkit-media-controls-panel {
            background: rgba(255, 255, 255, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6b7280;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1 id="content-title">Audio Recordings</h1>
                <p id="content-subtitle">Loading recordings...</p>
            </div>

            <div class="recordings-list" id="recordings-list">
                <div class="loading">Loading recordings...</div>
            </div>

            <!-- Audio Player -->
            <div class="player-section">
                <h3>Audio Player</h3>
                <div class="current-file" id="current-file">No file selected</div>
                <audio id="audio-player" controls>
                    Your browser does not support the audio element.
                </audio>
            </div>
        </div>
    </div>

    <script>
        // Audio Player Module
        class AudioPlayerModule {
            constructor() {
                this.folderHandle = null;
                this.audioFolderHandle = null;
                this.recordings = [];
                this.selectedStudent = null;
                this.currentRecordingIndex = -1;

                // Context from parent
                this.currentStudentId = null;
                this.currentStudentName = null;
                this.currentClass = null;

                this.init();
            }

            async init() {
                // Get folder handle from parent (passed via message)
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'taskmodule:init') {
                        this.handleInit(event.data);
                    }
                });

                // Request initialization from parent
                window.parent.postMessage({ type: 'taskmodule:ready' }, '*');
            }

            async handleInit(data) {
                console.log('Audio player initialized with context:', data);

                // Store context from parent
                this.currentStudentId = data.studentId || null;
                this.currentStudentName = data.studentName || null;
                this.currentClass = data.class || null;

                // Get folder handle from parent app
                if (window.parent.app && window.parent.app.fileManager) {
                    this.folderHandle = window.parent.app.fileManager.getFolderHandle();

                    if (this.folderHandle) {
                        await this.loadRecordings();
                    } else {
                        this.showError('No folder selected. Please load data from a folder first.');
                    }
                } else {
                    this.showError('App not initialized properly.');
                }
            }

            async loadRecordings() {
                try {
                    console.log('Attempting to load audio_files folder...');

                    // Get audio_files subfolder (create if doesn't exist)
                    this.audioFolderHandle = await this.folderHandle.getDirectoryHandle('audio_files', { create: true });

                    console.log('audio_files folder found/created');

                    // Read all audio files
                    this.recordings = [];
                    for await (const entry of this.audioFolderHandle.values()) {
                        if (entry.kind === 'file' && this.isAudioFile(entry.name)) {
                            const file = await entry.getFile();
                            this.recordings.push({
                                name: entry.name,
                                handle: entry,
                                file: file,
                                lastModified: file.lastModified,
                                studentName: this.extractStudentName(entry.name)
                            });
                            console.log('Loaded recording:', entry.name);
                        }
                    }

                    // Sort by date (newest first)
                    this.recordings.sort((a, b) => b.lastModified - a.lastModified);

                    console.log(`Successfully loaded ${this.recordings.length} recordings`);

                    // Filter and display based on context
                    this.displayRecordingsForContext();

                } catch (error) {
                    console.error('Error loading recordings:', error);
                    console.error('Error details:', error.message, error.stack);
                    this.showError(`Error loading recordings: ${error.message}. Check console for details.`);
                }
            }

            displayRecordingsForContext() {
                let filteredRecordings = [];
                let title = '';
                let subtitle = '';

                // Case 1: Student is selected - show only that student's recordings
                if (this.currentStudentName) {
                    const sanitizedName = this.currentStudentName.toLowerCase().replace(/\s+/g, '');
                    filteredRecordings = this.recordings.filter(r => r.studentName === sanitizedName);

                    title = this.currentStudentName;
                    subtitle = `${filteredRecordings.length} recording(s)`;
                }
                // Case 2: Class is selected but no student - show class-wide recordings (allstudents)
                else if (this.currentClass) {
                    // Class recordings are named like: allstudents_classname_timestamp.webm
                    const sanitizedClass = this.currentClass.toLowerCase().replace(/\s+/g, '');
                    filteredRecordings = this.recordings.filter(r => {
                        // Check if it's an allstudents recording and matches the class
                        return r.studentName === 'allstudents' && r.name.toLowerCase().includes(sanitizedClass);
                    });

                    title = `${this.currentClass} - Class Recordings`;
                    subtitle = `${filteredRecordings.length} recording(s)`;
                }
                // Case 3: No context - show nothing
                else {
                    filteredRecordings = [];
                    title = 'No Context Selected';
                    subtitle = 'Select a student or class to view recordings';
                }

                // Update header
                document.getElementById('content-title').textContent = title;
                document.getElementById('content-subtitle').textContent = subtitle;

                // Display the filtered recordings
                this.renderRecordingsList(filteredRecordings);
            }

            isAudioFile(filename) {
                const ext = filename.toLowerCase().split('.').pop();
                return ['webm', 'mp3', 'wav', 'm4a', 'ogg'].includes(ext);
            }

            extractStudentName(filename) {
                // Extract student name from filename pattern: studentname_class_timestamp.ext
                const parts = filename.split('_');
                if (parts.length >= 3 && parts[0] !== 'allstudents') {
                    return parts[0];
                }
                return 'allstudents';
            }

            renderRecordingsList(recordings) {
                const listContainer = document.getElementById('recordings-list');
                listContainer.innerHTML = '';

                if (recordings.length === 0) {
                    listContainer.innerHTML = '<div class="no-recordings">No recordings found</div>';
                    return;
                }

                recordings.forEach((recording, index) => {
                    const item = document.createElement('div');
                    item.className = 'recording-item';

                    const date = new Date(recording.lastModified);
                    const dateStr = date.toLocaleString();

                    item.innerHTML = `
            <div class="recording-name">${recording.name}</div>
            <div class="recording-meta">${dateStr}</div>
          `;

                    item.addEventListener('click', () => {
                        this.playRecording(recording, item);
                    });

                    listContainer.appendChild(item);
                });
            }

            async playRecording(recording, itemElement) {
                try {
                    // Update active item
                    document.querySelectorAll('.recording-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    itemElement.classList.add('active');

                    // Load file and play
                    const file = recording.file;
                    const url = URL.createObjectURL(file);

                    const audioPlayer = document.getElementById('audio-player');
                    audioPlayer.src = url;
                    audioPlayer.load();
                    audioPlayer.play();

                    document.getElementById('current-file').textContent = recording.name;

                } catch (error) {
                    console.error('Error playing recording:', error);
                    this.showError(`Failed to play recording: ${error.message}`);
                }
            }

            showError(message) {
                const listContainer = document.getElementById('recordings-list');
                listContainer.innerHTML = `<div class="no-recordings">${message}</div>`;
            }
        }

        // Initialize the audio player module
        const audioPlayer = new AudioPlayerModule();
    </script>
</body>

</html>