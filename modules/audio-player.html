<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 40px);
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* Left Sidebar - Student Roster */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #fef3c7 0%, #fed7aa 100%);
            padding: 20px;
            overflow-y: auto;
            border-right: 3px solid #fbbf24;
        }

        .sidebar h2 {
            font-size: 24px;
            color: #3b82f6;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b82f6;
        }

        .student-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .student-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, #ddd6fe 0%, #c7d2fe 100%);
            border: 2px solid #e0e7ff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #4c1d95;
            transition: all 0.2s;
            text-align: left;
        }

        .student-btn:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            transform: translateX(5px);
        }

        .student-btn.active {
            background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%);
            color: white;
            border-color: white;
        }

        /* Green indicator for students with recordings */
        .student-btn.has-recording {
            background: linear-gradient(135deg, #6ee7b7 0%, #34d399 100%);
            border-color: #10b981;
            color: #065f46;
        }

        .student-btn.has-recording:hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .all-students-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            border: 2px solid white;
            padding: 14px;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .all-students-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
            transform: translateX(0) scale(1.02);
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }

        .content-header {
            margin-bottom: 20px;
        }

        .content-header h1 {
            font-size: 32px;
            color: #3b82f6;
            margin-bottom: 8px;
        }

        .content-header p {
            font-size: 18px;
            color: #6b7280;
        }

        /* Recordings List */
        .recordings-list {
            flex: 1;
            overflow-y: auto;
            background: #f9fafb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .recording-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recording-item:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .recording-item.active {
            border-color: #ec4899;
            background: #fdf2f8;
        }

        .recording-name {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .recording-meta {
            font-size: 14px;
            color: #6b7280;
        }

        .no-recordings {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-size: 18px;
        }

        /* Audio Player */
        .player-section {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }

        .player-section h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .current-file {
            font-size: 16px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        audio {
            width: 100%;
            outline: none;
        }

        audio::-webkit-media-controls-panel {
            background: rgba(255, 255, 255, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #6b7280;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <h2>Select Student</h2>
            <button class="student-btn all-students-btn" id="all-students-btn">
                ðŸ“¢ All Students
            </button>
            <div class="student-list" id="student-list">
                <!-- Student buttons will be populated here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1 id="content-title">Audio Recordings</h1>
                <p id="content-subtitle">Select a student or view all recordings</p>
            </div>

            <div class="recordings-list" id="recordings-list">
                <div class="loading">Loading recordings...</div>
            </div>

            <!-- Audio Player -->
            <div class="player-section">
                <h3>Audio Player</h3>
                <div class="current-file" id="current-file">No file selected</div>
                <audio id="audio-player" controls>
                    Your browser does not support the audio element.
                </audio>
            </div>
        </div>
    </div>

    <script>
        // Audio Player Module
        class AudioPlayerModule {
            constructor() {
                this.folderHandle = null;
                this.audioFolderHandle = null;
                this.recordings = [];
                this.students = [];
                this.selectedStudent = null;
                this.currentRecordingIndex = -1;

                this.init();
            }

            async init() {
                // Get folder handle from parent (passed via message)
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'taskmodule:init') {
                        this.handleInit(event.data);
                    }
                });

                // Setup UI event listeners
                document.getElementById('all-students-btn').addEventListener('click', () => {
                    this.showAllStudents();
                });

                // Request initialization from parent
                window.parent.postMessage({ type: 'taskmodule:ready' }, '*');
            }

            async handleInit(data) {
                console.log('Audio player initialized with context:', data);

                // Get folder handle from parent app
                if (window.parent.app && window.parent.app.fileManager) {
                    this.folderHandle = window.parent.app.fileManager.getFolderHandle();

                    if (this.folderHandle) {
                        await this.loadRecordings();
                    } else {
                        this.showError('No folder selected. Please load data from a folder first.');
                    }
                } else {
                    this.showError('App not initialized properly.');
                }

                // Get students list
                if (window.parent.app && window.parent.app.students) {
                    this.students = window.parent.app.students;
                    this.renderStudentList();
                }
            }

            async loadRecordings() {
                try {
                    console.log('Attempting to load audio_files folder...');

                    // Get audio_files subfolder (create if doesn't exist)
                    this.audioFolderHandle = await this.folderHandle.getDirectoryHandle('audio_files', { create: true });

                    console.log('audio_files folder found/created');

                    // Read all audio files
                    this.recordings = [];
                    for await (const entry of this.audioFolderHandle.values()) {
                        if (entry.kind === 'file' && this.isAudioFile(entry.name)) {
                            const file = await entry.getFile();
                            this.recordings.push({
                                name: entry.name,
                                handle: entry,
                                file: file,
                                lastModified: file.lastModified,
                                studentName: this.extractStudentName(entry.name)
                            });
                            console.log('Loaded recording:', entry.name);
                        }
                    }

                    // Sort by date (newest first)
                    this.recordings.sort((a, b) => b.lastModified - a.lastModified);

                    console.log(`Successfully loaded ${this.recordings.length} recordings`);

                    // Show all recordings by default
                    this.showAllStudents();

                } catch (error) {
                    console.error('Error loading recordings:', error);
                    console.error('Error details:', error.message, error.stack);
                    this.showError(`Error loading recordings: ${error.message}. Check console for details.`);
                }
            }

            isAudioFile(filename) {
                const ext = filename.toLowerCase().split('.').pop();
                return ['webm', 'mp3', 'wav', 'm4a', 'ogg'].includes(ext);
            }

            extractStudentName(filename) {
                // Extract student name from filename pattern: studentname_class_timestamp.ext
                const parts = filename.split('_');
                if (parts.length >= 3 && parts[0] !== 'allstudents') {
                    return parts[0];
                }
                return 'allstudents';
            }

            renderStudentList() {
                const listContainer = document.getElementById('student-list');
                listContainer.innerHTML = '';

                // Sort students by name
                const sortedStudents = [...this.students].sort((a, b) =>
                    a.name.localeCompare(b.name)
                );

                sortedStudents.forEach(student => {
                    const hasRecording = this.hasRecordingForStudent(student.name);

                    const btn = document.createElement('button');
                    btn.className = `student-btn ${hasRecording ? 'has-recording' : ''}`;
                    btn.textContent = student.name;
                    btn.dataset.studentId = student.student_id;
                    btn.dataset.studentName = student.name;

                    btn.addEventListener('click', () => {
                        this.selectStudent(student);
                    });

                    listContainer.appendChild(btn);
                });
            }

            hasRecordingForStudent(studentName) {
                const sanitizedName = studentName.toLowerCase().replace(/\s+/g, '');
                return this.recordings.some(r => r.studentName === sanitizedName);
            }

            selectStudent(student) {
                this.selectedStudent = student;

                // Update active button
                document.querySelectorAll('.student-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                // Filter and show recordings
                const sanitizedName = student.name.toLowerCase().replace(/\s+/g, '');
                const studentRecordings = this.recordings.filter(r =>
                    r.studentName === sanitizedName
                );

                // Update header
                document.getElementById('content-title').textContent = student.name;
                document.getElementById('content-subtitle').textContent =
                    `${studentRecordings.length} recording(s)`;

                this.renderRecordingsList(studentRecordings);
            }

            showAllStudents() {
                this.selectedStudent = null;

                // Update active button
                document.querySelectorAll('.student-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('all-students-btn').classList.add('active');

                // Show all recordings
                document.getElementById('content-title').textContent = 'All Recordings';
                document.getElementById('content-subtitle').textContent =
                    `${this.recordings.length} total recording(s)`;

                this.renderRecordingsList(this.recordings);
            }

            renderRecordingsList(recordings) {
                const listContainer = document.getElementById('recordings-list');
                listContainer.innerHTML = '';

                if (recordings.length === 0) {
                    listContainer.innerHTML = '<div class="no-recordings">No recordings found</div>';
                    return;
                }

                recordings.forEach((recording, index) => {
                    const item = document.createElement('div');
                    item.className = 'recording-item';

                    const date = new Date(recording.lastModified);
                    const dateStr = date.toLocaleString();

                    item.innerHTML = `
            <div class="recording-name">${recording.name}</div>
            <div class="recording-meta">${dateStr}</div>
          `;

                    item.addEventListener('click', () => {
                        this.playRecording(recording, item);
                    });

                    listContainer.appendChild(item);
                });
            }

            async playRecording(recording, itemElement) {
                try {
                    // Update active item
                    document.querySelectorAll('.recording-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    itemElement.classList.add('active');

                    // Load file and play
                    const file = recording.file;
                    const url = URL.createObjectURL(file);

                    const audioPlayer = document.getElementById('audio-player');
                    audioPlayer.src = url;
                    audioPlayer.load();
                    audioPlayer.play();

                    document.getElementById('current-file').textContent = recording.name;

                } catch (error) {
                    console.error('Error playing recording:', error);
                    this.showError(`Failed to play recording: ${error.message}`);
                }
            }

            showError(message) {
                const listContainer = document.getElementById('recordings-list');
                listContainer.innerHTML = `<div class="no-recordings">${message}</div>`;
            }
        }

        // Initialize the audio player module
        const audioPlayer = new AudioPlayerModule();
    </script>
</body>

</html>