<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dance Viewer</title>
    <style>
        :root {
            --module-scale: 1;
        }

        body.resolution-4k {
            --module-scale: 2;
            transform: scale(2);
            transform-origin: top left;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: calc(15px * var(--module-scale));
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .dance-title {
            font-size: calc(36px * var(--module-scale));
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: calc(5px * var(--module-scale));
            text-align: center;
        }

        .dance-subtitle {
            font-size: calc(20px * var(--module-scale));
            font-style: italic;
            color: #555;
            text-align: center;
            margin-bottom: calc(12px * var(--module-scale));
        }

        .dance-selector-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: calc(12px * var(--module-scale));
            margin-bottom: calc(12px * var(--module-scale));
        }

        .dance-selector-label {
            font-size: calc(18px * var(--module-scale));
            font-weight: bold;
            color: #2c3e50;
        }

        .dance-selector {
            padding: calc(10px * var(--module-scale)) calc(16px * var(--module-scale));
            font-size: calc(18px * var(--module-scale));
            border: 2px solid #667eea;
            border-radius: calc(8px * var(--module-scale));
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-width: calc(250px * var(--module-scale));
        }

        .dance-selector:hover {
            border-color: #764ba2;
        }

        .dance-selector:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: calc(12px * var(--module-scale));
            margin-top: calc(10px * var(--module-scale));
        }

        .play-btn {
            width: calc(60px * var(--module-scale));
            height: calc(60px * var(--module-scale));
            border-radius: 50%;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.6);
        }

        .play-btn:active {
            transform: translateY(0);
        }

        .play-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .play-icon, .pause-icon {
            width: calc(24px * var(--module-scale));
            height: calc(24px * var(--module-scale));
            fill: white;
        }

        .pause-icon {
            display: none;
        }

        .play-btn.playing .play-icon {
            display: none;
        }

        .play-btn.playing .pause-icon {
            display: block;
        }

        .progress-container {
            flex: 1;
            max-width: calc(400px * var(--module-scale));
            height: calc(20px * var(--module-scale));
            background: #e0e0e0;
            border-radius: calc(10px * var(--module-scale));
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-display {
            font-size: calc(14px * var(--module-scale));
            color: #666;
            min-width: calc(100px * var(--module-scale));
            text-align: center;
        }

        .dance-chart-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: calc(15px * var(--module-scale));
        }

        .section {
            background: white;
            border-radius: calc(10px * var(--module-scale));
            padding: calc(12px * var(--module-scale));
            margin-bottom: calc(12px * var(--module-scale));
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: calc(10px * var(--module-scale));
            align-items: center;
        }

        .section-letter {
            font-size: calc(56px * var(--module-scale));
            font-weight: bold;
            color: #2c3e50;
            padding: calc(10px * var(--module-scale));
            text-align: center;
            width: calc(80px * var(--module-scale));
        }

        .section-content {
            display: flex;
            flex-direction: column;
            gap: calc(8px * var(--module-scale));
        }

        .beat-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: calc(6px * var(--module-scale));
            align-items: start;
        }

        .repeat-start {
            font-size: calc(36px * var(--module-scale));
            font-weight: bold;
            color: #333;
            padding: 0 calc(5px * var(--module-scale));
            display: flex;
            align-items: center;
            align-self: stretch;
        }

        .beat-rows {
            display: flex;
            flex-direction: column;
            gap: calc(4px * var(--module-scale));
        }

        .beat-row {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: calc(3px * var(--module-scale));
        }

        .beat-box {
            min-width: calc(60px * var(--module-scale));
            height: calc(60px * var(--module-scale));
            border: calc(2px * var(--module-scale)) solid #333;
            border-radius: calc(4px * var(--module-scale));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: calc(16px * var(--module-scale));
            color: #222;
            padding: calc(4px * var(--module-scale));
            text-align: center;
            word-wrap: break-word;
            line-height: 1.2;
        }

        .repeat-end {
            font-size: calc(36px * var(--module-scale));
            font-weight: bold;
            color: #333;
            padding-left: calc(5px * var(--module-scale));
            display: flex;
            align-items: center;
        }

        .speaker-icon {
            width: calc(40px * var(--module-scale));
            height: calc(40px * var(--module-scale));
            opacity: 0.6;
        }

        .section-note {
            font-size: calc(18px * var(--module-scale));
            font-style: italic;
            color: #555;
            text-align: center;
            margin-top: calc(8px * var(--module-scale));
            grid-column: 1 / -1;
        }

        .error-message {
            text-align: center;
            padding: calc(40px * var(--module-scale));
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: calc(8px * var(--module-scale));
            margin: calc(20px * var(--module-scale));
        }

        /* Scrollbar styling */
        .dance-chart-container::-webkit-scrollbar {
            width: calc(10px * var(--module-scale));
        }

        .dance-chart-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        .dance-chart-container::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: calc(5px * var(--module-scale));
        }

        .dance-chart-container::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="dance-selector-container">
            <label class="dance-selector-label" for="danceSelector">Select Dance:</label>
            <select class="dance-selector" id="danceSelector">
                <option value="">Loading dances...</option>
            </select>
        </div>

        <div class="dance-title" id="danceTitle">Select a dance to begin</div>
        <div class="dance-subtitle" id="danceSubtitle"></div>

        <div class="audio-controls">
            <button class="play-btn" id="playBtn" disabled>
                <svg class="play-icon" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                <svg class="pause-icon" viewBox="0 0 24 24">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
        </div>
    </div>

    <div class="dance-chart-container" id="danceChartContainer">
        <!-- Dance sections will be rendered here -->
    </div>

    <audio id="danceAudio" preload="auto"></audio>

    <script>
        // Detect 4K resolution and apply scaling
        if (window.screen.width >= 3840 || window.screen.height >= 2160) {
            document.body.classList.add('resolution-4k');
        }

        let currentDance = null;
        let audioElement = null;
        let availableDances = [];

        window.TaskModule = {
            async init(context) {
                console.log('Dance Viewer init with context:', context);

                try {
                    // Get the list of available dances from parent app
                    const dances = await window.parent.app.getDances();
                    console.log('Received dances from parent:', dances);

                    if (!dances) {
                        throw new Error('getDances() returned null or undefined');
                    }

                    if (dances.length === 0) {
                        const selector = document.getElementById('danceSelector');
                        selector.innerHTML = '<option value="">No dances found - check dances.csv exists in data folder</option>';
                        this.showError('No dances found in dances.csv. Make sure the file exists in your data folder with dance entries.');
                        return;
                    }

                    // Populate the dropdown with the dances
                    this.populateDanceSelector(dances);

                    // Set up the dance selector change handler
                    const selector = document.getElementById('danceSelector');
                    selector.addEventListener('change', async (e) => {
                        const danceId = e.target.value;
                        if (danceId) {
                            await this.loadAndDisplayDance(danceId);
                        }
                    });

                } catch (error) {
                    console.error('Error initializing dance viewer:', error);
                    const selector = document.getElementById('danceSelector');
                    selector.innerHTML = '<option value="">Error: ' + error.message + '</option>';
                    this.showError('Failed to load dances: ' + error.message);
                }
            },

            async loadAndDisplayDance(danceId) {
                try {
                    // Load dance from parent app
                    const danceJson = await window.parent.app.loadDance(danceId);
                    currentDance = JSON.parse(danceJson);

                    console.log('Loaded dance:', currentDance);

                    // Render the dance
                    this.renderDance(currentDance);

                    // Load audio
                    this.loadAudio(currentDance.audioFile);

                } catch (error) {
                    console.error('Error loading dance:', error);
                    this.showError(error.message);
                }
            },

            populateDanceSelector(dances) {
                console.log('Populating dance selector with:', dances);
                const selector = document.getElementById('danceSelector');
                selector.innerHTML = '<option value="">-- Select a Dance --</option>';

                if (!dances || dances.length === 0) {
                    selector.innerHTML = '<option value="">No dances available</option>';
                    this.showError('No dances found in dances.csv');
                    return;
                }

                dances.forEach(dance => {
                    if (dance && dance.id && dance.title) {
                        const option = document.createElement('option');
                        option.value = dance.id;
                        option.textContent = dance.title;
                        selector.appendChild(option);
                    }
                });

                availableDances = dances;

                // Auto-select first dance if available
                if (dances.length > 0 && dances[0].id) {
                    selector.value = dances[0].id;
                    this.loadAndDisplayDance(dances[0].id);
                }
            },

            renderDance(dance) {
                // Set title and subtitle
                document.getElementById('danceTitle').textContent = dance.title || 'Untitled Dance';
                document.getElementById('danceSubtitle').textContent = dance.subtitle || '';

                // Render sections
                const container = document.getElementById('danceChartContainer');
                container.innerHTML = '';

                if (!dance.sections || dance.sections.length === 0) {
                    container.innerHTML = '<div class="error-message">No sections defined for this dance.</div>';
                    return;
                }

                dance.sections.forEach(section => {
                    const sectionEl = this.createSectionElement(section);
                    container.appendChild(sectionEl);
                });
            },

            createSectionElement(section) {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';

                // Section letter
                const letterDiv = document.createElement('div');
                letterDiv.className = 'section-letter';
                letterDiv.textContent = section.letter || '?';
                sectionDiv.appendChild(letterDiv);

                // Section content (beat grid)
                const contentDiv = document.createElement('div');
                contentDiv.className = 'section-content';

                const beatGrid = document.createElement('div');
                beatGrid.className = 'beat-grid';

                // Repeat start marker (if repeats)
                if (section.repeats) {
                    const repeatStart = document.createElement('div');
                    repeatStart.className = 'repeat-start';
                    repeatStart.innerHTML = 'ùÑÜ'; // Unicode repeat start symbol
                    beatGrid.appendChild(repeatStart);
                } else {
                    beatGrid.appendChild(document.createElement('div')); // Empty spacer
                }

                // Beat rows
                const beatRows = document.createElement('div');
                beatRows.className = 'beat-rows';

                if (section.rows && section.rows.length > 0) {
                    section.rows.forEach(row => {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'beat-row';

                        // Each row should have 8 beats
                        for (let i = 0; i < 8; i++) {
                            const beatBox = document.createElement('div');
                            beatBox.className = 'beat-box';
                            beatBox.style.backgroundColor = section.color || '#f0f0f0';
                            beatBox.textContent = row[i] || '';
                            rowDiv.appendChild(beatBox);
                        }

                        beatRows.appendChild(rowDiv);
                    });
                } else {
                    beatRows.innerHTML = '<div class="error-message">No beats defined for this section.</div>';
                }

                beatGrid.appendChild(beatRows);
                contentDiv.appendChild(beatGrid);

                // Section note (if present)
                if (section.note) {
                    const noteDiv = document.createElement('div');
                    noteDiv.className = 'section-note';
                    noteDiv.textContent = section.note;
                    contentDiv.appendChild(noteDiv);
                }

                sectionDiv.appendChild(contentDiv);

                // Decorative speaker icon on right (if repeats)
                if (section.repeats) {
                    const repeatEnd = document.createElement('div');
                    repeatEnd.className = 'repeat-end';
                    repeatEnd.innerHTML = 'ùÑá'; // Unicode repeat end symbol
                    sectionDiv.appendChild(repeatEnd);
                } else {
                    // Decorative speaker icon (non-functional)
                    const speakerDiv = document.createElement('div');
                    speakerDiv.innerHTML = `
                        <svg class="speaker-icon" viewBox="0 0 24 24" fill="#666">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    `;
                    sectionDiv.appendChild(speakerDiv);
                }

                return sectionDiv;
            },

            loadAudio(audioPath) {
                audioElement = document.getElementById('danceAudio');
                const playBtn = document.getElementById('playBtn');
                const progressBar = document.getElementById('progressBar');
                const progressContainer = document.getElementById('progressContainer');
                const timeDisplay = document.getElementById('timeDisplay');

                audioElement.src = audioPath;

                // Enable play button when audio is loaded
                audioElement.addEventListener('canplay', () => {
                    playBtn.disabled = false;
                });

                // Play/Pause button
                playBtn.addEventListener('click', () => {
                    if (audioElement.paused) {
                        audioElement.play();
                        playBtn.classList.add('playing');
                    } else {
                        audioElement.pause();
                        playBtn.classList.remove('playing');
                    }
                });

                // Update progress bar
                audioElement.addEventListener('timeupdate', () => {
                    const progress = (audioElement.currentTime / audioElement.duration) * 100;
                    progressBar.style.width = progress + '%';

                    // Update time display
                    const currentMin = Math.floor(audioElement.currentTime / 60);
                    const currentSec = Math.floor(audioElement.currentTime % 60).toString().padStart(2, '0');
                    const durationMin = Math.floor(audioElement.duration / 60);
                    const durationSec = Math.floor(audioElement.duration % 60).toString().padStart(2, '0');
                    timeDisplay.textContent = `${currentMin}:${currentSec} / ${durationMin}:${durationSec}`;
                });

                // Seek by clicking progress bar
                progressContainer.addEventListener('click', (e) => {
                    const rect = progressContainer.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const width = rect.width;
                    const percentage = clickX / width;
                    audioElement.currentTime = percentage * audioElement.duration;
                });

                // Reset play button when audio ends
                audioElement.addEventListener('ended', () => {
                    playBtn.classList.remove('playing');
                    progressBar.style.width = '0%';
                });

                // Handle audio load errors
                audioElement.addEventListener('error', () => {
                    console.error('Error loading audio file:', audioPath);
                    timeDisplay.textContent = 'Audio unavailable';
                });
            },

            showError(message) {
                document.getElementById('danceTitle').textContent = 'Error';
                document.getElementById('danceSubtitle').textContent = '';
                document.getElementById('danceChartContainer').innerHTML =
                    `<div class="error-message">${message}</div>`;
            },

            getResponse() {
                // No response needed for view-only module
                return "";
            },

            isComplete() {
                // Always complete (view-only, no interaction required)
                return true;
            },

            reset() {
                // Stop audio playback
                if (audioElement) {
                    audioElement.pause();
                    audioElement.currentTime = 0;
                    const playBtn = document.getElementById('playBtn');
                    playBtn.classList.remove('playing');
                }
            }
        };

        // Listen for messages from parent app
        window.addEventListener('message', function (event) {
            if (event.data && event.data.type === 'taskmodule:init') {
                window.TaskModule.init(event.data.context);
            }
        });

        // Notify parent that module is ready
        window.addEventListener('load', function () {
            console.log('Dance viewer module loaded');
        });
    </script>
</body>
</html>
